<!-- 
  Sartoria Global Navbar - Mega Menü Versiyonu
  Tema: İtalyan Zarafeti & Modern Zanaatkarlık
  Özellik: 3 Seviyeli Dropdown ve Kategori Entegrasyonu
-->
<% 
  // Dinamik Kategori Link Yardımcısı
  function getCatId(name, defaultId) {
    if (typeof categories !== 'undefined' && categories && categories.length > 0) {
      const cat = categories.find(c => c.name.toLowerCase() === name.toLowerCase());
      return cat ? cat.id : defaultId;
    }
    return defaultId;
  }
%>
<nav class="navbar navbar-expand-lg sticky-top sartoria-nav">
  <div class="container">
    <!-- Marka Logosu -->
    <a class="navbar-brand d-flex align-items-center" href="/">
      <i class="bi bi-scissors me-2 text-accent"></i>
      <span class="fw-900">SARTORIA<span class="text-accent">.</span></span>
    </a>

    <!-- Mobil Menü Butonu -->
    <button
      class="navbar-toggler border-0 shadow-none"
      type="button"
      data-bs-toggle="collapse"
      data-bs-target="#navbarNav"
    >
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">
      
      <!-- Minimalist Arama Çubuğu (Sadece alt çizgili) -->
      <form
        class="d-flex mx-auto my-3 my-lg-0 navbar-search"
        action="/products/search"
        method="GET"
      >
        <div class="input-group">
          <input
            type="text"
            class="form-control"
            name="keyword"
            placeholder="Koleksiyonda ara..."
            required
          />
          <button class="btn" type="submit">
            <i class="bi bi-search"></i>
          </button>
        </div>
      </form>

      <!-- Sağ Menü ve Kategoriler -->
      <ul class="navbar-nav ms-auto align-items-center">
        
        <!-- 1. KUMAŞLAR (Mega Menü) -->
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="kumasDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                KUMAŞLAR
            </a>
            <ul class="dropdown-menu dropdown-menu-custom shadow-lg border-0" aria-labelledby="kumasDropdown">
                <li><a class="dropdown-item" href="/products?category=<%= getCatId('Penye Kumaş', 5) %>">Penye Kumaş</a></li>
                <li><a class="dropdown-item" href="/products?category=<%= getCatId('Viskon Kumaş', 6) %>">Viskon Kumaş</a></li>
                <li><a class="dropdown-item" href="/products?category=<%= getCatId('Müslin Kumaş', 7) %>">Müslin Kumaş</a></li>
                <li><a class="dropdown-item" href="/products?category=<%= getCatId('Krep Kumaş', 8) %>">Krep Kumaş</a></li>
                <li><a class="dropdown-item" href="/products?category=<%= getCatId('Kaşe Kumaş', 9) %>">Kaşe Kumaş</a></li>
                <li><a class="dropdown-item" href="/products?category=<%= getCatId('Tedi Kumaş', 10) %>">Tedi Kumaş</a></li>
                <li><hr class="dropdown-divider" /></li>
                <li><a class="dropdown-item fw-bold text-accent" href="/products?type=0">TÜM KUMAŞLAR</a></li>
            </ul>
        </li>

        <!-- 2. HAZIR GİYİM (İç İçe Menü) -->
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="giyimDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                HAZIR GİYİM
            </a>
            <ul class="dropdown-menu dropdown-menu-custom shadow-lg border-0" aria-labelledby="giyimDropdown">
                
                <!-- Kadın Giyim -->
                <li class="dropdown-submenu">
                    <a class="dropdown-item dropdown-toggle d-flex justify-content-between align-items-center" href="#">
                        Kadın Giyim <i class="bi bi-chevron-right small ms-2"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-custom shadow-lg border-0">
                        <li><a class="dropdown-item" href="/products?category=<%= getCatId('Elbise', 13) %>">Elbise</a></li>
                        <li><a class="dropdown-item" href="/products?category=<%= getCatId('Pijama Takımı', 14) %>">Pijama Takımı</a></li>
                        <li><a class="dropdown-item" href="/products?category=<%= getCatId('Eşofman Takımı', 15) %>">Eşofman Takımı</a></li>
                        <li><a class="dropdown-item" href="/products?category=<%= getCatId('Sweatshirt', 16) %>">Sweatshirt</a></li>
                    </ul>
                </li>

                <!-- Çocuk Giyim -->
                <li class="dropdown-submenu">
                    <a class="dropdown-item dropdown-toggle d-flex justify-content-between align-items-center" href="#">
                        Çocuk Giyim <i class="bi bi-chevron-right small ms-2"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-custom shadow-lg border-0">
                        <li><a class="dropdown-item" href="/products?category=<%= getCatId('Çocuk Elbise', 17) %>">Çocuk Elbise</a></li>
                        <li><a class="dropdown-item" href="/products?category=<%= getCatId('Çocuk Pijama', 18) %>">Çocuk Pijama</a></li>
                        <li><a class="dropdown-item" href="/products?category=<%= getCatId('Çocuk Eşofman', 19) %>">Çocuk Eşofman</a></li>
                        <li><a class="dropdown-item" href="/products?category=<%= getCatId('Çocuk Sweatshirt', 20) %>">Çocuk Sweatshirt</a></li>
                    </ul>
                </li>

                <li><hr class="dropdown-divider" /></li>
                <li><a class="dropdown-item fw-bold text-accent" href="/products?type=1">TÜM KOLEKSİYON</a></li>
            </ul>
        </li>

        <!-- 3. KALIPLAR -->
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="kalipDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                KALIPLAR
            </a>
            <ul class="dropdown-menu dropdown-menu-custom shadow-lg border-0" aria-labelledby="kalipDropdown">
                <li><a class="dropdown-item" href="/products?category=<%= getCatId('Kadın Kalıpları', 21) %>">Kadın Kalıpları</a></li>
                <li><a class="dropdown-item" href="/products?category=<%= getCatId('Çocuk Kalıpları', 22) %>">Çocuk Kalıpları</a></li>
                <li><a class="dropdown-item" href="/products?category=<%= getCatId('Erkek Kalıpları', 23) %>">Erkek Kalıpları</a></li>
                <li><hr class="dropdown-divider" /></li>
                <li><a class="dropdown-item fw-bold text-accent" href="/products?type=2">TÜM KALIPLAR</a></li>
            </ul>
        </li>

        <!-- 4. AKSESUARLAR -->
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="aksesuarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                AKSESUARLAR
            </a>
            <ul class="dropdown-menu dropdown-menu-custom shadow-lg border-0" aria-labelledby="aksesuarDropdown">
                <li><a class="dropdown-item" href="/products?category=<%= getCatId('Dikiş Malzemeleri', 24) %>">Dikiş Malzemeleri</a></li>
                <li><a class="dropdown-item" href="/products?category=<%= getCatId('Fermuar & Düğme', 25) %>">Fermuar & Düğme</a></li>
                <li><a class="dropdown-item" href="/products?category=<%= getCatId('Yaka & Astar', 26) %>">Yaka & Astar</a></li>
                <li><hr class="dropdown-divider" /></li>
                <li><a class="dropdown-item fw-bold text-accent" href="/products?type=3">TÜM AKSESUARLAR</a></li>
            </ul>
        </li>

        <!-- Sepet İkonu -->
        <li class="nav-item ms-lg-3">
          <a class="nav-link position-relative px-3" href="/cart">
            <i class="bi bi-bag-heart fs-4"></i>
            <% let currentCartCount = 0; if (typeof cartCount !== 'undefined' && cartCount !== null) { currentCartCount = cartCount; } %>
            <span
              class="cart-badge cart-badge-custom position-absolute translate-middle-x"
              style="<%= currentCartCount > 0 ? '' : 'display:none;' %>"
            >
              <%= currentCartCount %>
            </span>
          </a>
        </li>

        <!-- Kullanıcı Menüsü -->
        <% if (typeof user !== 'undefined' && user) { %>
        <li class="nav-item dropdown ms-lg-2">
          <a
            class="nav-link dropdown-toggle d-flex align-items-center"
            href="#"
            data-bs-toggle="dropdown"
          >
            <i class="bi bi-person-circle fs-5 me-2 text-accent"></i>
            <span class="d-none d-lg-inline fw-900 text-uppercase">
              <%= (user.username) ? user.username : (user.email ? user.email.split('@')[0] : 'PROFİL') %>
            </span>
          </a>
          <ul class="dropdown-menu dropdown-menu-end dropdown-menu-custom shadow-lg border-0">
            <li><a class="dropdown-item" href="/profile"><i class="bi bi-person me-2"></i>PROFİLİM</a></li>
            <li><a class="dropdown-item" href="/orders"><i class="bi bi-box-seam me-2"></i>SİPARİŞLERİM</a></li>
            <% if (user.role === 'Admin') { %>
            <li><hr class="dropdown-divider" /></li>
            <li><a class="dropdown-item text-accent fw-bold" href="/admin"><i class="bi bi-shield-check me-2"></i>YÖNETİM</a></li>
            <% } %>
            <li><hr class="dropdown-divider" /></li>
            <li><a class="dropdown-item text-danger fw-bold" href="/auth/logout"><i class="bi bi-box-arrow-right me-2"></i>ÇIKIŞ YAP</a></li>
          </ul>
        </li>
        <% } else { %>
        <li class="nav-item ms-lg-4">
          <a class="btn btn-sartoria-nav" href="/auth/login">GİRİŞ YAP</a>
        </li>
        <% } %>
      </ul>
    </div>
  </div>
</nav>

<style>
  /* Sartoria Navbar - Global Modern Teması */
  .sartoria-nav {
    background-color: var(--sartoria-white, #ffffff) !important;
    border-bottom: 2px solid var(--sartoria-border, #e2ddd3);
    padding: 1.2rem 0;
  }

  .navbar-brand {
    font-family: "Cormorant Garamond", serif !important;
    font-size: 2.2rem !important;
    color: var(--sartoria-dark, #3d3d3d) !important;
    letter-spacing: 2px;
  }

  .text-accent {
    color: var(--sartoria-accent, #a68b6d) !important;
  }
  .fw-900 {
    font-weight: 900 !important;
  }

  /* Menü Linkleri */
  .nav-link {
    font-size: 0.75rem !important;
    font-weight: 800 !important;
    letter-spacing: 2px;
    color: var(--sartoria-dark, #3d3d3d) !important;
    padding: 0.5rem 1rem !important;
    transition: 0.3s ease;
    text-transform: uppercase;
  }

  .nav-link:hover, .nav-item.dropdown:hover > .nav-link {
    color: var(--sartoria-accent, #a68b6d) !important;
    transform: translateY(-1px);
  }

  /* Arama Alanı */
  .navbar-search {
    max-width: 280px;
    width: 100%;
    border-bottom: 2px solid var(--sartoria-dark, #3d3d3d);
    transition: border-color 0.3s ease;
  }

  .navbar-search:focus-within {
    border-color: var(--sartoria-accent, #a68b6d);
  }

  .navbar-search .form-control {
    border: none !important;
    background: transparent !important;
    font-weight: 700;
    font-size: 0.85rem;
    padding-left: 0;
    color: var(--sartoria-dark, #3d3d3d);
    box-shadow: none !important;
  }

  .navbar-search .btn {
    border: none;
    color: var(--sartoria-dark, #3d3d3d);
    padding-right: 0;
  }

  /* Dropdown Menüler */
  .dropdown-menu-custom {
    border-radius: 0;
    background: var(--sartoria-white, #ffffff);
    margin-top: 15px; /* Navbar ile boşluk */
    padding: 10px 0;
    min-width: 220px;
  }

  .dropdown-item {
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 1px;
    padding: 12px 25px;
    color: var(--sartoria-dark, #3d3d3d);
    text-transform: uppercase;
    transition: 0.2s ease;
  }

  .dropdown-item:hover {
    background-color: var(--sartoria-bg, #f8f5f0);
    color: var(--sartoria-accent, #a68b6d);
    padding-left: 30px; /* Sağa kayma efekti */
  }

  /* İç İçe Dropdown (Nested Menu) */
  .dropdown-submenu {
      position: relative;
  }

  .dropdown-submenu .dropdown-menu {
      top: 0;
      left: 100%; /* Sağa doğru açıl */
      margin-top: -5px;
      margin-left: 0;
      display: none; /* Varsayılan gizli */
  }

  /* Masaüstü Hover Mantığı */
  @media (min-width: 992px) {
      .nav-item.dropdown:hover > .dropdown-menu {
          display: block;
          animation: fadeUp 0.3s ease forwards;
      }
      
      .dropdown-submenu:hover > .dropdown-menu {
          display: block;
          animation: fadeLeft 0.3s ease forwards;
      }
  }

  /* Giriş Butonu */
  .btn-sartoria-nav {
    background-color: var(--sartoria-dark, #3d3d3d);
    color: white !important;
    border-radius: 0;
    font-weight: 800;
    font-size: 0.75rem;
    padding: 12px 30px;
    letter-spacing: 2px;
    border: 1px solid var(--sartoria-dark, #3d3d3d);
    transition: 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
  }

  .btn-sartoria-nav:hover {
    background-color: transparent;
    color: var(--sartoria-dark, #3d3d3d) !important;
  }

  /* Sepet Rozeti */
  .cart-badge-custom {
    background: var(--sartoria-accent, #a68b6d);
    color: white;
    font-size: 0.65rem;
    font-weight: 800;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    top: 5px;
    right: 5px;
    border-radius: 50%;
  }

  /* Animasyonlar */
  @keyframes fadeUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
  }
  @keyframes fadeLeft {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
  }

  /* Mobil Düzenlemeler */
  @media (max-width: 991.98px) {
    .navbar-search {
      max-width: 100%;
      margin-bottom: 1.5rem;
    }
    .nav-link {
      padding: 12px 0 !important;
      border-bottom: 1px solid var(--sartoria-border, #e2ddd3);
    }
    .btn-sartoria-nav {
      width: 100%;
      margin-top: 15px;
    }
    .navbar-brand {
      font-size: 1.8rem !important;
    }
    /* Mobilde iç içe menüyü alt alta göster */
    .dropdown-submenu .dropdown-menu {
        position: static;
        display: block;
        box-shadow: none;
        padding-left: 20px;
        background: transparent;
    }
  }
</style>